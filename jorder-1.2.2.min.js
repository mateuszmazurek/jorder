var jOrder=function(b,a){return jOrder.table(b||[],a)};jOrder.core=function(){var a={MAX_DEPTH:10,delegate:function(c,d,b){d=d||jOrder;var e;for(e in c){if(!b&&c.hasOwnProperty(e)||b.hasOwnProperty(e)&&(e in c)){d[e]=c[e]}}return c},deep:function(e,f,g){g=g||0;if(g>=a.MAX_DEPTH){throw"Deep copying exceeded maximum depth ("+a.MAX_DEPTH+")"}var b,c=e&&typeof e.length!=="undefined",d;f=c&&f===true;if(typeof e!=="object"||e===null){return e}b=c?[]:{};for(d in e){if(e.hasOwnProperty(d)){if(f){b.push(a.deep(e[d],f,g+1))}else{b[d]=a.deep(e[d],f,g+1)}}}return b},shallow:function(d,e){var b,c;if(e){b=[];for(c in d){if(!isNaN(c)){b.push(d[c])}}}else{b=d.concat([])}return b},keys:function(c){var b=[],d;for(d in c){if(c.hasOwnProperty(d)){b.push(d)}}return b},values:function(c){var b=[],d;for(d in c){if(c.hasOwnProperty(d)){b.push(c[d])}}return b},split:function(c){var e=[],b=[],d;for(d in c){if(c.hasOwnProperty(d)){e.push(d);b.push(c[d])}}return{keys:e,values:b}},join:function(e,d){var b={},c;for(c in e){if(e.hasOwnProperty(c)){b[e[c]]=d[c]}}return b},hash:function(b){return Math.abs(b.split("").reduce(function(d,c){d=((d<<5)-d)+c.charCodeAt(0);return d&d},0))},copyTable:function(b){return a.deep(b,true)}};return a.delegate(a)}();if(typeof Object.create!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}jOrder.constants=function(a){return a.delegate({name:"jOrder",asc:1,desc:-1,string:0,number:1,text:2,array:3,start:0,end:1,exact:0,range:1,startof:2,AND:1,OR:2})}(jOrder.core);jOrder.logging=function(c){var b=typeof window==="object"?window.console:console,a={log:function(d){if(b&&jOrder.logging){b.log(d)}},warn:function(d){if(b&&jOrder.logging){b.warn(d)}},error:function(){a.warn("Use throw instead of .error()")}};a.warning=a.warn;return c.delegate(a)}(jOrder.core);jOrder.collection=function(a){return function(){var c={},d=0,b={add:function(e,f){if(c.hasOwnProperty(e)){a.warn("Overwriting existing item '"+e+"'");delete c[e];d--}c[e]=f;d++;return this},get:function(e){if(!c.hasOwnProperty(e)){a.warn("Invalid item name: '"+e+"'");return}return c[e]},clear:function(){c={};d=0;return this},each:function(f){var e;for(e in c){if(c.hasOwnProperty(e)&&f(e,c[e])===true){return this}}return this},count:function(){return d}};return b}}(jOrder.logging);jOrder.signature=function(a,b){return function(c,e){if((typeof c==="undefined"||!c.length)&&typeof c!=="function"){throw"No field(s) specified"}e=e||{};if(c.length>1){switch(e.type){case a.text:throw"Can't create a text index on more than one field.";case a.number:throw"Can't create a number index on more than one field."}}var d={options:e,signature:function(j,f){if(!j){return typeof c==="function"?b.hash(c.toString()):escape(c.join("_"))}var g,h;if(f){h=b.join(c,[]);for(g in j){if(j.hasOwnProperty(g)&&!h.hasOwnProperty(g)){return false}}}else{for(g=0;g<c.length;g++){if(!j.hasOwnProperty(c[g])){return false}}}return true},key:function(j){if(d.options.type===a.number){return j[c[0]]}var g=[],f,h;for(f=0;f<c.length;f++){h=c[f];if(!j.hasOwnProperty(h)){return undefined}g.push(j[h])}return escape(g.join("_"))},keys:function(g){switch(d.options.type){case a.array:return g[c[0]];case a.text:return(typeof c==="function"?c.call(g):g[c[0]]).split(/\s+/g);default:case a.number:case a.string:var f=d.key(g);return typeof f!=="undefined"?[f]:[]}}};return d}}(jOrder.constants,jOrder.core);jOrder.lookup=function(b,a,c){return function(g,d,f){var j=c(d,f),e=Object.create(j),k,h;e.clear=function(){k={};h=0};e.clear();e.add=function(o,p){var m,l,n;for(m=0;m<o.length;m++){l=o[m];if(e.options.grouped){if(!k.hasOwnProperty(l)){n={items:{},count:1};n.items[p]=p;k[l]=n;h++}else{n=k[l];if(!n.items.hasOwnProperty(p)){n.count++;n.items[p]=p;h++}}}else{if(k.hasOwnProperty(l)){throw"Can't add more than one row ID to the non-grouped index '"+e.signature()+"'. Consider using a group index instead."}k[l]=p;h++}}};e.remove=function(o,p){var m,l,n;for(m=0;m<o.length;m++){l=o[m];if(!k.hasOwnProperty(l)){throw"Can't remove row. Row '"+l+"' doesn't match signature '"+e.signature()+"'."}if(!e.options.grouped){delete k[l];h--;return}if(typeof p==="undefined"){throw"Must pass rowId when deleting from group index."}n=k[l];if(n.items&&n.items.hasOwnProperty(p)){n.count--;h--}if(!n.count){delete k[l]}else{delete n.items[p]}}};e.lookup=function(q){var l=[],o,n,p,m;for(o in q){if(k.hasOwnProperty(n=e.key(q[o]))){p=k[n].items;if(p){for(m in p){if(p.hasOwnProperty(m)){l.push(p[m])}}}else{l.push(k[n])}}}return l};e.flat=function(){return k};e.count=function(l){if(typeof l==="undefined"){return h}else{if(!k.hasOwnProperty(l)){return 0}else{if(e.options.grouped){return k[l].count}else{return 1}}}};return e}}(jOrder.constants,jOrder.logging,jOrder.signature);jOrder.order=function(b,a,d){var c=100;return function(j,f,h){var m=d(f,h),g=Object.create(m),e;g.clear=function(){e=[]};g.clear();g.reorder=function(){e.sort(function(o,n){if(o.key>n.key){return 1}else{if(o.key<n.key){return -1}else{if(o.rowId>n.rowId){return 1}else{if(o.rowId<n.rowId){return -1}else{return 0}}}}})};function k(o,n){switch(g.options.type){case b.text:return o.match(new RegExp("^"+n));default:case b.string:case b.number:return o===n}}g.add=function(q,s,p){var o,n,t,r;for(o=0;o<q.length;o++){n=q[o];switch(g.options.type){case b.text:case b.array:r=n.toLowerCase();break;default:r=n;break}if(p){e.push({key:r,rowId:s})}else{t=e.length>0?g.bsearch(r,b.start,s):0;e.splice(t,0,{key:r,rowId:s})}}};g.remove=function(o,p){var n,q;for(n=0;n<o.length;n++){q=g.bsearch(o[n],b.start,p);e.splice(q,1)}};function l(p,u,n,s){var r=typeof s!=="undefined",o,q,t=e[u];if((!r||t.rowId===s)&&k(t.key,p)){return{pos:u,exact:true}}if(n-u<=1){return{pos:u,exact:false}}o=u+Math.floor((n-u)/2);q=e[o];if(q.key<p||r&&q.key===p&&q.rowId<s){return l(p,o,n,s)}else{return l(p,u,o,s)}}g.bsearch=function(v,s,p){if(!e.length){return -1}var o=0,r=e[0],q=e.length-1,u=e[q],w=typeof p!=="undefined",n,t;if(v<r.key||w&&k(r.key,v)&&p<r.rowId){return s===b.start?o:-1}else{if(v>u.key||w&&k(u.key,v)&&p>u.rowId){return s===b.end?q:e.length}}n=l(v,o,q,p);if(n.exact){t=s===b.start?n.pos:n.pos-1}else{t=s===b.start?n.pos+1:n.pos}return t};g.range=function(t,q){t=t||{};q=q||{};q.offset=q.offset||0;q.limit=q.limit||c;var p,s,u,o,n=[],r;switch(g.options.type){case b.text:p=t.lower?escape(t.lower.toLowerCase()):t.lower;s=t.upper?escape(t.upper.toLowerCase()):t.upper;break;case b.string:p=t.lower?escape(t.lower):t.lower;s=t.upper?escape(t.upper):t.upper;break;default:p=t.lower;s=t.upper;break}u=(typeof p!=="undefined"?g.bsearch(p,b.start):0)+q.offset;o=Math.min(typeof s!=="undefined"?g.bsearch(s,b.end):e.length-1,u+q.limit-1);for(r=u;r<=o;r++){n.push(e[r].rowId)}return n};g.order=function(o,n){if(!e.length){return e}o=o||b.asc;n=n||{};n.offset=n.offset||0;n.limit=n.limit||0;if(o===b.asc&&!n.offset&&!n.limit){return e}n.limit=n.limit||c;switch(o){case b.desc:return e.slice(Math.max(0,e.length-n.offset-n.limit),e.length-n.offset).reverse();default:case b.asc:return e.slice(n.offset,Math.min(n.offset+n.limit,e.length))}};g.compact=function(){a.warn("Compacting is obsolete")};return g}}(jOrder.constants,jOrder.logging,jOrder.signature);jOrder.index=function(e,c,b,a,d){return function(k,g,j){j=j||{};j.type=j.type||c.string;var l=a(k,g,j),f=j.ordered?d(k,g,j):null,h={add:function(p,o,m){var n=h.keys(p);if(!n.length){throw"Can't add row to index. No field matches signature '"+h.signature()+"'"}l.add(n,o);if(f){f.add(n,o,m)}return h},remove:function(o,n){var m=h.keys(o);if(!m.length){throw"Can't remove row from index. No field matches signature '"+h.signature()+"'"}l.remove(m,n);if(f){f.remove(m,n)}return h},unbuild:function(){l.clear();if(f){f.clear()}return h},rebuild:function(n){h.unbuild();b.log("Building index of length: "+k.length+", signature '"+l.signature()+"'.");var m,o;for(m=0;m<k.length;m++){if(!(o=k[m])){continue}h.add(o,m,n)}if(f&&n){f.reorder()}return h},grouped:function(){return Boolean(j.grouped)},ordered:function(){return Boolean(f)},type:function(){return j.type}};e.delegate(l,h,{lookup:true,flat:true,count:true,signature:true,key:true,keys:true});if(f){e.delegate(f,h,{reorder:true,compact:true,bsearch:true,range:true,order:true})}if(j.build!==false){h.rebuild(true)}return h}}(jOrder.core,jOrder.constants,jOrder.logging,jOrder.lookup,jOrder.order);jOrder.indexes=function(b,a){return function(f){var c=Object.create(b()),e=c.add,d={},g=0;c.add=function(k,h,j){e(k,a(f,h,j))};c.find=function(k,j){j=j||{};if(k){return c.get(k)}var h;c.each(function(l,m){if((typeof j.row==="undefined"||m.signature(j.row,true))&&(typeof j.grouped==="undefined"||m.grouped()===j.grouped)){h=m;return true}});return h};c.rebuild=function(){c.each(function(j,h){h.rebuild()})};c.ordered=function(h){var j=c.find(null,{row:h});if(!j){return false}return j.ordered()};c.grouped=function(h){var j=c.find(null,{row:h});if(!j){return false}return j.grouped()};return c}}(jOrder.collection,jOrder.index);jOrder.selectors=function(a){return{exact:function(g,e){var c=false,b,h,d,f;for(d=0;d<e.conditions.length;d++){b=true;h=e.conditions[d];for(f in h){if(h.hasOwnProperty(f)){b&=(h[f]===g[f]);if(!b){break}}}c|=b;if(c){break}}return c},startof:function(d,c){var b=a.split(c.conditions[0]);return d[b.keys[0]].indexOf(b.values[0])===0},range:function(f,d){var c=a.split(d.conditions[0]),b=c.values[0],e=c.keys[0];return b.lower<=f[e]&&b.upper>f[e]}}}(jOrder.core);jOrder.table=function(d,b,a,c,e){return function(j,h){h=h||{renumber:false};var g=c(j),f={index:function(m,k,l){if(!m){g.rebuild();return f}else{if(!k){return g.get(m)}else{g.add(m,k,l);return f}}},reindex:function(){g.rebuild();return f},clear:function(){g.clear();return f},update:function(p,r,n){n=n||{};var m=g.find(n.indexName,{grouped:false}),o,q,l,k;if(p){if(!m){throw"Can't find suitable index for fields: '"+d.keys(p).join(",")+"'."}q=m.lookup([p])[0];p=j[q]}if(typeof q==="undefined"){if(!r){a.warn("Update called but nothing changed.");return f}l=j.push(r)-1}else{delete j[q];if(r){l=j.push(r)-1}}g.each(function(t,s){if(p){s.remove(p,q)}if(r){s.add(r,l)}});return f},insert:function(m,k){var l;for(l=0;l<m.length;l++){f.update(null,m[l],k)}return f},remove:function(m,k){var l;for(l=0;l<m.length;l++){f.update(m[l],null,k)}return f},select:function(l,m){m=m||{};var k=[],n,o;if(m.renumber){for(n=0;n<l.length;n++){k.push(j[l[n]])}}else{for(n=0;n<l.length;n++){o=l[n];k[o]=j[o]}}return k},logics:{},where:function(r,t){t=t||{};var q=g.find(t.indexName||d.keys(r[0])[0]||null,{row:r[0]}),m,k,p,o,s,l;if(q){switch(t.mode){case b.range:k=r?d.values(r[0])[0]:null;if(k){p=typeof k==="object"?k:{lower:k,upper:k};m=q.range({lower:p.lower,upper:p.upper},t)}else{m={lower:null,upper:null}}break;case b.startof:r=r||[];t.logic=t.logic||b.OR;if(r.length>0){var m=[];for(var n=0;n<r.length;n+=1){o=d.values(r[n])[0];m.push(q.range({lower:o,upper:o+"z"},t))}m=f.logics[t.logic](m)}else{m=q.range({lower:null,upper:null},t)}break;default:case b.exact:if(t.offset||t.limit){a.warn("Running 'jOrder.table.where()' in 'exact' mode with offset and limit specified. Consider running it in 'range' mode.")}m=r?q.lookup(r):d.values(q.flat());break}return f.select(m,{renumber:t.renumber})}else{a.warn("No matching index for fields: '"+d.keys(r[0]).join(",")+"'.");switch(t.mode){case b.range:l=e.range;break;case b.startof:l=e.startof;break;default:case b.exact:l=e.exact;break}return f.filter(l,t,{conditions:r})}},aggregate:function(s,k,p){var u={},q=g.find(s),t,m,r,o,l,n;if(!q.grouped()){throw"Can't aggregate using a non-group index! Signature: '"+q.signature()+"'."}a.warn("Aggregation iterates over table (length: "+j.length+").");t=q.flat();for(m in t){if(t.hasOwnProperty(m)){r=t[m].items;for(n in r){if(r.hasOwnProperty(n)){o=j[n];break}}if(k){l=p(k(o),d.deep(o))}else{l=d.deep(o)}for(n in r){if(r.hasOwnProperty(n)&&j[n]!==o){l=p(l,j[n])}}u[m]=l}}return u},orderby:function(m,p,o){o=o||{};p=p||b.asc;var n=g.find(o.indexName,{row:d.join(m,[])}),l,k,q;if(n.type()===b.text){throw"Can't order by free-text index: '"+m.join(",")+"'."}if(n.order){l=n.order(p,o);k=[];for(q=0;q<l.length;q++){k.push(l[q].rowId)}return f.select(k,{renumber:true})}else{a.warn("Unordered index or no index available. Sorting table on the fly.");return d.shallow(j).sort(function(s,r){return s[m[0]]>r[m[0]]?1:s[m[0]]<r[m[0]]?-1:0})}},filter:function(l,n,p){a.warn("Performing linear search on table (length: "+j.length+"). Consider using an index.");n=n||{};n.offset=n.offset||0;var k=[],o,q,m=0;for(o in j){if(j.hasOwnProperty(o)&&l(q=j[o],p)){if(m++>=n.offset){if(n.renumber){k.push(q)}else{k[o]=q}}if(n.limit&&m===n.offset+n.limit){break}}}return k},count:function(){if(g.count()){return g.find().count()}else{a.warn("Indexless row count iterates over table (length: "+j.length+").");return d.keys(j).length}},flat:function(){return j},indexes:function(){return g},first:function(){var k;for(k in j){if(j.hasOwnProperty(k)){return j[k]}}},column:function(n,l){l=l||{};var k=[],m;if(l.renumber){for(m in j){if(j.hasOwnProperty(m)){k.push(j[m][n])}}return k}for(m in j){if(j.hasOwnProperty(m)){k[m]=j[m][n]}}return k}};f.logics[b.AND]=function(k){k.sort(function(n,m){return n.length>m.length});var l;while(k.length>1){l=[];for(i=0;i<k[0].length;i++){if(k[1].indexOf(k[0][i])>=0){l.push(k[0][i])}}k[0]=l;k.splice(1,1)}return k[0]};f.logics[b.OR]=function(k){while(k.length>1){for(i=0;i<k[1].length;i++){if(k[0].indexOf(k[1][i])<0){k[0].push(k[1][i])}}k.splice(1,1)}return k[0]};d.delegate(g,f,{ordered:true,grouped:true});return f}}(jOrder.core,jOrder.constants,jOrder.logging,jOrder.indexes,jOrder.selectors);